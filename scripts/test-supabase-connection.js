#!/usr/bin/env node

console.log('ðŸ”— TESTANDO CONECTIVIDADE COM SUPABASE');
console.log('');

console.log('ðŸ“‹ ESTE SCRIPT TESTA:');
console.log('   âœ“ Conectividade bÃ¡sica com Supabase');
console.log('   âœ“ AutenticaÃ§Ã£o com service_role');
console.log('   âœ“ Acesso Ã  tabela projects');
console.log('   âœ“ PolÃ­ticas RLS');
console.log('   âœ“ Estrutura da tabela');
console.log('');

console.log('ðŸš€ PARA EXECUTAR ESTE TESTE:');
console.log('');

console.log('1. ðŸ“ Crie um arquivo de teste:');
console.log('   test-connection.mjs');
console.log('');

console.log('2. ðŸ“ Cole este cÃ³digo no arquivo:');
console.log('```javascript');
console.log('import { createClient } from "@supabase/supabase-js";');
console.log('');
console.log('const supabaseUrl = "https://uvdyxurnvatomlxevrmu.supabase.co";');
console.log('const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;');
console.log('');
console.log('if (!serviceRoleKey) {');
console.log('  console.error("âŒ SUPABASE_SERVICE_ROLE_KEY nÃ£o encontrada!");');
console.log('  process.exit(1);');
console.log('}');
console.log('');
console.log('console.log("ðŸ”‘ Service Role Key:", serviceRoleKey.substring(0, 20) + "...");');
console.log('');
console.log('const supabase = createClient(supabaseUrl, serviceRoleKey, {');
console.log('  auth: {');
console.log('    autoRefreshToken: false,');
console.log('    persistSession: false');
console.log('  }');
console.log('});');
console.log('');
console.log('async function testConnection() {');
console.log('  try {');
console.log('    console.log("ðŸ” Testando conectividade bÃ¡sica...");');
console.log('    ');
console.log('    // Teste 1: Health check bÃ¡sico');
console.log('    const { data: healthData, error: healthError } = await supabase');
console.log('      .from("projects")');
console.log('      .select("id")');
console.log('      .limit(1);');
console.log('    ');
console.log('    if (healthError) {');
console.log('      console.error("âŒ Health check falhou:", healthError);');
console.log('      return;');
console.log('    }');
console.log('    ');
console.log('    console.log("âœ… Conectividade bÃ¡sica: OK");');
console.log('    console.log("ðŸ“Š Projetos encontrados:", healthData?.length || 0);');
console.log('    ');
console.log('    // Teste 2: Verificar estrutura da tabela');
console.log('    console.log("ðŸ” Verificando estrutura da tabela...");');
console.log('    ');
console.log('    const { data: tableData, error: tableError } = await supabase');
console.log('      .from("projects")');
console.log('      .select("id, number, name, created_at")');
console.log('      .limit(1);');
console.log('    ');
console.log('    if (tableError) {');
console.log('      console.error("âŒ Erro ao acessar tabela:", tableError);');
console.log('      return;');
console.log('    }');
console.log('    ');
console.log('    console.log("âœ… Estrutura da tabela: OK");');
console.log('    ');
console.log('    // Teste 3: Testar query especÃ­fica para geraÃ§Ã£o de nÃºmeros');
console.log('    console.log("ðŸ” Testando query de geraÃ§Ã£o de nÃºmeros...");');
console.log('    ');
console.log('    const currentYear = new Date().getFullYear();');
console.log('    const prefix = `FV-${currentYear}-`;');
console.log('    ');
console.log('    const { data: numberData, error: numberError } = await supabase');
console.log('      .from("projects")');
console.log('      .select("number")');
console.log('      .like("number", `${prefix}%`)');
console.log('      .order("number", { ascending: false })');
console.log('      .limit(1);');
console.log('    ');
console.log('    if (numberError) {');
console.log('      console.error("âŒ Erro na query de nÃºmeros:", numberError);');
console.log('      return;');
console.log('    }');
console.log('    ');
console.log('    console.log("âœ… Query de nÃºmeros: OK");');
console.log('    console.log("ðŸ“Š Ãšltimo nÃºmero encontrado:", numberData?.[0]?.number || "nenhum");');
console.log('    ');
console.log('    // Teste 4: Simular inserÃ§Ã£o (sem executar)');
console.log('    console.log("ðŸ” Testando preparaÃ§Ã£o de inserÃ§Ã£o...");');
console.log('    ');
console.log('    const testProjectData = {');
console.log('      name: "Projeto Teste",');
console.log('      number: `${prefix}999`,');
console.log('      created_by: "00000000-0000-0000-0000-000000000000", // UUID fake');
console.log('      status: "NÃ£o Iniciado"');
console.log('    };');
console.log('    ');
console.log('    console.log("âœ… Dados de teste preparados:", testProjectData);');
console.log('    console.log("â„¹ï¸  InserÃ§Ã£o nÃ£o executada (apenas teste de preparaÃ§Ã£o)");');
console.log('    ');
console.log('    console.log("ðŸŽ‰ TODOS OS TESTES PASSARAM!");');
console.log('    console.log("âœ… Supabase estÃ¡ funcionando corretamente");');
console.log('    ');
console.log('  } catch (error) {');
console.log('    console.error("âŒ Erro geral:", error);');
console.log('  }');
console.log('}');
console.log('');
console.log('testConnection();');
console.log('```');
console.log('');

console.log('3. ðŸƒ Execute o teste:');
console.log('   node test-connection.mjs');
console.log('');

console.log('ðŸ“Š RESULTADOS ESPERADOS:');
console.log('');

console.log('âœ… SE TUDO ESTIVER OK:');
console.log('   - Conectividade bÃ¡sica: OK');
console.log('   - Estrutura da tabela: OK');
console.log('   - Query de nÃºmeros: OK');
console.log('   - Dados de teste preparados');
console.log('   - TODOS OS TESTES PASSARAM!');
console.log('');

console.log('âŒ SE HOUVER PROBLEMAS:');
console.log('   - Health check falhou â†’ Problema de conectividade/RLS');
console.log('   - Erro ao acessar tabela â†’ Tabela nÃ£o existe ou RLS');
console.log('   - Erro na query de nÃºmeros â†’ Campo "number" nÃ£o existe');
console.log('   - Erro geral â†’ Problema na chave ou configuraÃ§Ã£o');
console.log('');

console.log('ðŸ”§ SOLUÃ‡Ã•ES BASEADAS NO RESULTADO:');
console.log('');

console.log('ðŸ›¡ï¸  SE RLS ESTIVER BLOQUEANDO:');
console.log('   1. Acesse Supabase Dashboard');
console.log('   2. Authentication > Policies');
console.log('   3. Crie polÃ­tica para service_role');
console.log('');

console.log('ðŸ—„ï¸  SE TABELA NÃƒO EXISTIR:');
console.log('   1. Table Editor > Create Table');
console.log('   2. Use o SQL fornecido no script anterior');
console.log('');

console.log('ðŸ”‘ SE CHAVE ESTIVER INVÃLIDA:');
console.log('   1. Settings > API');
console.log('   2. Copie novamente a service_role key');
console.log('   3. Atualize nas variÃ¡veis de ambiente da Vercel');
console.log('');

console.log('ðŸš€ EXECUTE O TESTE AGORA!'); 